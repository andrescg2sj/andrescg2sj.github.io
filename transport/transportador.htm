<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" /> 
<style>
.plus-button {
    background-color: #80dd80;
    font-size: 20pt;
}

.minus-button {
    background-color: #dd8080;
    font-size: 20pt;
}

.reset-button {
    background-color: #e0e0dd;
    font-size: 20pt;
}

</style>
    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-156895209-1', 'auto');
    ga('send', 'pageview');
    </script>


<script>
/* A.Gonzalez. SJ AMDG */
CHAR_LYRICS = "*"
CHAR_CHORDS = "@"

LONG_WORD = 4


CHAR_SHARP = "#";
CHAR_FLAT = "b";
OCTAVE = 12;

var notes = {"do":0, "re":2, "mi":4, "fa":5, "sol":7, "la":9, "si":11};

var SHARP_SCALE = ["do", "do#","re", "re#", "mi", "fa", "fa#", 
		    "sol", "sol#", "la", "la#", "si"];
var FLAT_SCALE = ["do", "reb","re", "mib", "mi", "fa", "solb", 
		    "sol", "lab", "la", "sib", "si"];

function chord(cSpec) {
    this.tone = 0;
    this.chordText = cSpec;
    this.position = -1;
    this.modifiers = "";
 
	this.splitSpec = function(spec) {
		var parts = {tone: 0, strTone: "", rest: ""};
		for (var key in notes) {
			if (notes.hasOwnProperty(key)) {
				var len = key.length;
				if(spec.slice(0, len).toLowerCase() == key) {
					parts.strTone = spec.slice(0,len);
					parts.tone = notes[key];
					parts.rest = spec.slice(len);
					return parts;
				}
			}
		}
		return null; /* TODO: ? */
		
	}

	
	this.detectNote = function (spec) {
		var temp = this.splitSpec(cSpec);
		if(temp == null) {
			this.tone = null;
			return;
		}
		this.tone = temp.tone;
		this.strTone = temp.strTone;

		if(temp.rest.slice(0,1) == CHAR_SHARP) {
			this.tone += 1;
			this.shift = temp.rest.slice(0,1);
			temp.rest = temp.rest.slice(1);
		} else if(temp.rest.slice(0,1) == CHAR_FLAT) {
			this.tone -= 1;
			this.shift = temp.rest.slice(0,1);
			temp.rest = temp.rest.slice(1);
		}
		this.modifiers = temp.rest;
		if(this.tone < 0) this.tone += OCTAVE;
				
	};

	this.transposeChord = function(shift) {
		if(shift == 0 || this.tone == null) return this.chordText;
			// TODO: case sensitive
	        var tone = (this.tone + shift) % OCTAVE;
		if(this.shift == CHAR_FLAT) {
			return this.maskCase(FLAT_SCALE[tone],this.strTone) + this.modifiers;
		} else {
			return this.maskCase(SHARP_SCALE[tone],this.strTone) + this.modifiers;
		}
	};
	
	this.maskCase = function (strChord, mask) {
		if(mask.length == 0) {
			return strChord;
		} else if(mask.length == 1) {
			if(mask == mask.toLowerCase()) {
				return strChord.toLowerCase();
			} 
			return strChord.toUpperCase();
		} 

		var firstLetter = strChord.slice(0, 1);
		var rest = strChord.slice(1);
		var mask1 = mask.slice(0,1);
		var mask2 = mask.slice(1,2);
		if(mask1 == mask1.toLowerCase()) {
			firstLetter = firstLetter.toLowerCase();
		} else {
			firstLetter = firstLetter.toUpperCase();
		}
		if(mask2 == mask2.toLowerCase()) {
			rest = rest.toLowerCase();
		} else {
			rest = rest.toUpperCase();
		}
		if(rest.slice(-1).toLowerCase() == CHAR_FLAT) {
			rest = rest.slice(0,-1) + CHAR_FLAT;
		}
		return firstLetter + rest;	 

	}
    this.detectNote(cSpec);
}


function getFormText() {
	var x = document.getElementById("frm1");
    var i;
    for (i = 0; i < x.length ;i++) {
		if(x.elements[i].name == "mydata") {
			return x.elements[i].value;
		}
    }
	return "";
}



function iterateLine(line)
{
	//var chord = {note : ""; modifiers = ""}
	var pair = {rest : line, mChord : null}
	var i = line.indexOf("[");
	if(i == -1) {
		return pair;
	}
	var rest = line.substr(i);
	var j = rest.indexOf("]");
	if(j == -1) {
		return pair;
	}
	var chordSpec = line.slice(i+1,j+i);
	pair.mChord = new chord(chordSpec);
	pair.mChord.position = i;
	//pair.mChord.text = chordSpec;
	//pair.mChord = chordSpec;
	pair.rest = line.slice(0,i) + line.substr(j+i+1);
	return pair; // HTML
}


function genSpaces(num)
{
	if(num <= 0) return "";
	return Array(num + 1).join(" ");
}

function addChord(rest, chord,shift)
{
	//var line = rest;
	if((rest.length < chord.position) || (rest.length == 0 && chord.position == 0)) {
		var spaces = genSpaces(chord.position - rest.length);
		return rest + spaces + chord.transposeChord(shift);
	} else {
		return rest + "-" + chord.transposeChord(shift);
	}
}


function processLine(line, shift)
{
	
	var chords = [];
	var pair = iterateLine(line);
	while(pair.mChord != null) {
		chords.push(pair.mChord);
		pair = iterateLine(pair.rest);
	}
	
	var chdLine = "";
	for(var c in chords) {
		chdLine = addChord(chdLine, chords[c],shift);
		//chdLine = chdLine + "-" + chords[c].text;
	}
	var res = {chords : chdLine, text : pair.rest};
	return res; // HTML
}


function processData() {
	//document.getElementById("display").innerHTML = "Hello";
	var shift = parseInt(document.getElementById("shift-label").innerHTML);

	var text = getFormText();
	var lines = text.split("\n");
	var outText = "<pre>";
	for (var i = 0; i < lines.length; i++) {
		proc = processLine(lines[i], shift);
		outText = outText + proc.chords + "<br />" + proc.text + "<br />";			
		//outText = outText + i + ". " + lines[i] + "<br />";			
	}
	outText += "</pre>"
	document.getElementById("display").innerHTML =  outText;
}

function incrementShift()
{
   var text = document.getElementById("shift-label").innerHTML;
   tone = (parseInt(text) + 1) % OCTAVE; 
    document.getElementById("shift-label").innerHTML = tone;
	processData();
}

function decrementShift()
{
   var text = document.getElementById("shift-label").innerHTML;
   tone = parseInt(text) - 1; 
   if(tone < 0) tone += OCTAVE;
    document.getElementById("shift-label").innerHTML = tone;
	processData();
}

function resetShift()
{
    document.getElementById("shift-label").innerHTML = "0";
    processData();
}



/* --------------------------------------------------------------- */

/**
 * Return true if the line is a line of chords, 
 */
function detectLine(line) {

	// TODO: sanitize line
	// TODO: manage isolated "+7", etc
	
	var outText = ""; // debug...
	var tokens = line.split(/\s+/);
	outText = outText + " " + tokens.length + " tokens: ";
	var countChord = 0;
	var countNormal = 0;
	var countLong = 0;
	//TODO: count long words (e.g. more than 4 letters)
	for (var i = 0; i < tokens.length; i++) {
		//try to parse token as a chord
		
		if(tokens[i].length > 0) {
			ch = new chord(tokens[i]);
			outText = outText + "|"+ch.chordText;
		
			if(ch.tone == null) {
				countNormal += 1;
				if(tokens[i].length > LONG_WORD) {
					countLong += 1;
				}
			} else{
				countChord += 1;
			}
		}
		
	}
	outText = outText + "| chords:"+countChord + " normal:" + countNormal;
	
	//TODO: may be more complex
	var eval = false;
	if(countChord == 0 || countLong > 0) eval = false;
	else {
		eval = (countChord > countNormal);
	}
	return eval;
	//return outText;
}


function iterateChordLine(line, offset)
{
	//var chord = {note : ""; modifiers = ""}
	var pair = {rest : line, mChord : null}

	var i = line.search(/\S/); //search non-whitespace
	if(i == -1) {
		return pair;
	}
	var rest = line.substr(i);
	var j = rest.search(/\s/); //search whitespace
	if(j == -1) {
		j = rest.length;
	}
	var chordSpec = line.slice(i,j+i);
	pair.mChord = new chord(chordSpec);
	pair.mChord.position = i;
	//pair.mChord.text = chordSpec;
	//pair.mChord = chordSpec;
	pair.rest = line.slice(0,i) + genSpaces(j) + line.substr(j+i);
	return pair; // HTML
}


function processChordLine(line, shift)
{
	var chords = [];
	var pair = iterateChordLine(line);
	var count = 0;

	while(pair.mChord != null) {
		chords.push(pair.mChord);
		pair = iterateChordLine(pair.rest);
		count += 1;
	}
	
	var chdLine = "";
	for(var c in chords) {
		chdLine = addChord(chdLine, chords[c],shift);
		//chdLine = chdLine + "-" + chords[c].text;
	}
	var res = {chords : chdLine, text : pair.rest};
	return res; // HTML
}

function testChordLine() {
	//var text = getFormText();
	var shift = 2;
	var text = "     RE7";
	var outText = "<pre>";
	proc = processChordLine(text, shift);
	outText = outText + proc.chords + "<br />";
	outText = outText + "</pre>";
	
	document.getElementById("display").innerHTML =  outText;
}

function testDetectLine() 
{
	var shift = 2;

	var text = getFormText();
	var lines = text.split("\n");
	var outText = "<pre>";
	for (var i = 0; i < lines.length; i++) {
		//proc = processLine(lines[i], shift);
		//outText = outText + proc.chords + "<br />" + proc.text + "<br />";
		det = detectLine(lines[i]);
		// TODO: ...
		outText += lines[i] + "*" + det + "<br />";
	}
	outText += "</pre>"
	document.getElementById("display").innerHTML =  outText;
}



function detectChords() {
	//document.getElementById("display").innerHTML = "Hello";
	var shift = parseInt(document.getElementById("shift-label").innerHTML);

	var text = getFormText();
	var lines = text.split("\n");
	var outText = "<pre>";
	for (var i = 0; i < lines.length; i++) {
		//proc = processLine(lines[i], shift);
		//outText = outText + proc.chords + "<br />" + proc.text + "<br />";
		isChordLine = detectLine(lines[i]);
		if(isChordLine) {
			proc = processChordLine(lines[i], shift);
			outText = outText + proc.chords + "<br />";
		} else {
			outText = outText + lines[i] + "<br />";
		}
		
		//outText = outText + i + ". " + lines[i] + "<br />";			
	}
	outText += "</pre>"
	document.getElementById("display").innerHTML =  outText;
}


function incrementShiftCh()
{
   var text = document.getElementById("shift-label").innerHTML;
   tone = (parseInt(text) + 1) % OCTAVE; 
    document.getElementById("shift-label").innerHTML = tone;
	detectChords();
}

function decrementShiftCh()
{
   var text = document.getElementById("shift-label").innerHTML;
   tone = parseInt(text) - 1; 
   if(tone < 0) tone += OCTAVE;
    document.getElementById("shift-label").innerHTML = tone;
	detectChords();
}

function resetShiftCh()
{
    document.getElementById("shift-label").innerHTML = "0";
    detectChords();
}

function centerView(elem_id) {
	document.getElementById(elem_id).scrollIntoView(true);
}


</script>

</head>
<body>

<h1>Transportador de acordes de guitarra</h1>
<h2>¿Para qué sirve esta página?</h2>
Para cambiar la tonalidad de una canción con acordes de guitarra.

<h2>¿Qué hay que hacer?</h2>
<form id="frm1">
Puedes escribir en el siguiente cuadro el texto de la canción.
Los acordes deben ir en lineas alternadas con la letra, cada acorde sobre la sílaba en la que se toca.<br />
<textarea name="mydata" rows="10" cols="40">
mim          DO 
Yo celebraré 
                   RE7
Delante del Señor,
                  mim  
cantaré un canto nuevo.

mim  DO              RE7
Yo le alabaré porque Él ha hecho
mim
grandes cosas.
</textarea>
<br /> 
</form>
<p>Pulsa [+] o [-] para aumentar o disminuir el número de semitonos que se transportará la canción. Pulsa [0] para mostrar la canción en la tonalidad original.</p>


<p><span class="minus-button" onclick="decrementShiftCh();centerView('display')">[ - ]</span>
<span class="reset-button" onclick="resetShiftCh();centerView('display')">[ 0 ]</span>
<!-- <span class="reset-button" onclick="testChordLine()">[ 0 ]</span> -->
<span class="plus-button" onclick="incrementShiftCh();centerView('display')">[ + ]</span>
</p>
<h3 id="transportada">Canción transportada</h3>
<p>desplazamiento: <span id="shift-label">0</span></p>
<br />
<div id="display"></div>
<h3>Otros enlaces</h3>
<p><a href="http://andrescg2sj.github.io">Inicio</a></p>

</body>
</html> 
